name: MiniFlow CD (Deploy & Restart)

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      rollback:
        description: 'Restart service'
        type: boolean
        default: false

env:
  PYTHON_VERSION: "3.11"

jobs:
  deploy-production:
    name: üöÄ Deploy to Production
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && !inputs.rollback)
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://miniflow.vidinsight.com.tr:8000
    
    steps:
      - name: Deploy and manage service
        uses: appleboy/ssh-action@v1.0.3
        env:
          VERSION: ${{ github.run_number }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          envs: VERSION,GITHUB_REPO,GITHUB_TOKEN
          command_timeout: 30m
          script: |
            set -euo pipefail
            
            APP_NAME="miniflow"
            APP_DIR="/opt/miniflow/app"
            DATA_DIR="/opt/miniflow/data"
            LOG_DIR="/opt/miniflow/logs"
            DOMAIN="miniflow.vidinsight.com.tr"
            PORT=8000
            
            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            # CHECK: Servis var mƒ±?
            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if [ -f "/etc/systemd/system/${APP_NAME}.service" ]; then
              echo "‚úÖ Service EXISTS. Updating code and restarting..."
              
              # Kod dizinine git
              cd "${APP_DIR}" || { echo "‚ùå App directory not found!"; exit 1; }
              
              # Son kodu √ßek
              echo "üì• Pulling latest code..."
              git pull origin main || { echo "‚ùå Git pull failed!"; exit 1; }
              
              # Dependency g√ºncelle
              echo "üì¶ Updating dependencies..."
              pip3.11 install --user --upgrade -r requirements.txt
            
            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            # CREATE: Servis yoksa sƒ±fƒ±rdan olu≈ütur
            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            else
              echo "üÜï Service NOT FOUND. Creating from scratch..."
              
              # Dizinleri olu≈ütur
              echo "üìÅ Creating directories..."
              sudo mkdir -p "${APP_DIR}" "${DATA_DIR}" "${LOG_DIR}"
              sudo chown -R ubuntu:ubuntu /opt/miniflow
              
              # Repo'yu klonla
              echo "üì¶ Cloning repository..."
              cd /opt/miniflow
              git clone --depth 1 --branch main \
                https://${GITHUB_TOKEN}@github.com/${GITHUB_REPO}.git \
                "${APP_DIR}" || { echo "‚ùå Git clone failed!"; exit 1; }
              
              cd "${APP_DIR}"
              
              # Baƒüƒ±mlƒ±lƒ±klarƒ± y√ºkle
              echo "üì¶ Installing dependencies..."
              pip install --user --upgrade pip setuptools wheel
              pip install --user -r requirements.txt
              
              # Environment dosyasƒ± olu≈ütur
              echo "üìù Creating environment file..."
              cat > .env << EOF
              APP_ENV=production
              DB_TYPE=sqlite
              DATABASE_URL=sqlite:///${DATA_DIR}/miniflow.db
              CONFIG_PATH=./configurations/dev.ini
              JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
              SECRET_KEY=${{ secrets.SECRET_KEY }}
              SERVER_HOST=0.0.0.0
              SERVER_PORT=${PORT}
              LOG_LEVEL=${{ secrets.LOG_LEVEL || 'WARNING' }}
              DOMAIN=${DOMAIN}
              EOF
              
              # Config dosyasƒ± olu≈ütur
              echo "‚öôÔ∏è Creating configuration..."
              mkdir -p configurations
              cat > configurations/dev.ini << EOF
              [app]
              name = MiniFlow
              environment = production
              debug = false
              
              [server]
              host = 0.0.0.0
              port = ${PORT}
              workers = 1
              
              [database]
              type = sqlite
              path = ${DATA_DIR}/miniflow.db
              
              [logging]
              level = WARNING
              file = ${LOG_DIR}/app.log
              EOF
              
              # Database setup
              echo "üóÑÔ∏è Setting up database..."
              python3.11 -m src.miniflow setup
              python3.11 -m src.miniflow migrate || echo "No migrations needed"
              
              # Systemd servis dosyasƒ± olu≈ütur
              echo "‚öôÔ∏è Creating systemd service..."
              sudo tee /etc/systemd/system/${APP_NAME}.service > /dev/null << SERVICEEOF
              [Unit]
              Description=MiniFlow Application v${VERSION}
              After=network.target
              
              [Service]
              Type=simple
              User=ubuntu
              WorkingDirectory=${APP_DIR}
              Environment="PATH=/home/ubuntu/.local/bin:/usr/bin"
              Environment="PYTHONPATH=${APP_DIR}"
              EnvironmentFile=${APP_DIR}/.env
              ExecStart=/usr/bin/python3.11 -m src.miniflow run
              
              Restart=always
              RestartSec=10
              StandardOutput=append:${LOG_DIR}/app.log
              StandardError=append:${LOG_DIR}/error.log
              
              [Install]
              WantedBy=multi-user.target
              SERVICEEOF
              
              # Systemd'yƒ± yenile ve servisi etkinle≈ütir
              sudo systemctl daemon-reload
              sudo systemctl enable ${APP_NAME}
            fi
            
            echo "üîÑ Restarting ${APP_NAME} service..."
            sudo systemctl restart ${APP_NAME}
            
            # Health check
            echo "üè• Health checking on port ${PORT}..."
            for i in {1..20}; do
              if curl -f -s http://${DOMAIN}:${PORT}/health > /dev/null 2>&1; then
                echo "‚úÖ Application is running!"
                exit 0
              fi
              
              if [ $i -eq 10 ]; then
                echo "‚ö†Ô∏è 10 attempts failed, checking logs..."
                sudo journalctl -u ${APP_NAME} -n 20 --no-pager
              fi
              
              if [ $i -eq 20 ]; then
                echo "‚ùå Health check failed!"
                sudo systemctl status ${APP_NAME} --no-pager
                sudo journalctl -u ${APP_NAME} -n 30 --no-pager
                exit 1
              fi
              
              sleep 2
            done

      - name: Test deployment
        run: |
          sleep 5
          echo "Testing http://miniflow.vidinsight.com.tr:8000/health"
          curl -v http://miniflow.vidinsight.com.tr:8000/health || echo "Health check failed"

  rollback:
    name: üö® Emergency Restart
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.rollback
    environment:
      name: production
    
    steps:
      - name: Restart MiniFlow Service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          script: |
            echo "üö® Emergency restart requested..."
            sudo systemctl restart miniflow
            
            for i in {1..10}; do
              if curl -f -s http://miniflow.vidinsight.com.tr:8000/health > /dev/null 2>&1; then
                echo "‚úÖ Service restarted successfully!"
                exit 0
              fi
              sleep 3
            done
            
            echo "‚ùå Service restart failed!"
            sudo journalctl -u miniflow -n 20 --no-pager
            exit 1
