name: MiniFlow CI/CD Pipeline

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      rollback:
        description: 'Restart service'
        type: boolean
        default: false

env:
  PYTHON_VERSION: "3.11"

jobs:
  deploy-production:
    name: üöÄ Deploy to Production
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && !inputs.rollback)
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://miniflow.vidinsight.com.tr
    
    steps:
      - name: Deploy Application
        uses: appleboy/ssh-action@v1.0.3
        env:
          VERSION: ${{ github.run_number }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          envs: VERSION,GITHUB_REPO,GITHUB_TOKEN
          command_timeout: 30m
          script: |
            set -euo pipefail
            
            echo "üöÄ Deploying MiniFlow v${VERSION}"
            echo "üåê Direct Access: http://miniflow.vidinsight.com.tr"
            
            # Basit konfig√ºrasyon
            APP_NAME="miniflow"
            APP_DIR="/opt/miniflow/app"
            DATA_DIR="/opt/miniflow/data"
            LOG_DIR="/opt/miniflow/logs"
            DOMAIN="miniflow.vidinsight.com.tr"
            
            # Dizinleri olu≈ütur
            sudo mkdir -p "${APP_DIR}" "${DATA_DIR}" "${LOG_DIR}"
            sudo chown -R ubuntu:ubuntu /opt/miniflow
            
            # Eski kodu sil ve yeni kodu √ßek
            rm -rf "${APP_DIR}"
            echo "üì• Cloning repository..."
            git clone --depth 1 --branch main \
              https://${GITHUB_TOKEN}@github.com/${GITHUB_REPO}.git \
              "${APP_DIR}"
            
            cd "${APP_DIR}"
            
            # Baƒüƒ±mlƒ±lƒ±klarƒ± y√ºkle (GLOBAL)
            echo "üì¶ Installing dependencies..."
            pip3.11 install --user --upgrade pip setuptools wheel
            pip3.11 install --user -r requirements.txt
            
            # Environment dosyasƒ± olu≈ütur (PORT YOK!)
            cat > .env << EOF
            APP_ENV=production
            DB_TYPE=sqlite
            DATABASE_URL=sqlite:///${DATA_DIR}/miniflow.db
            CONFIG_PATH=./configurations/prod.ini
            JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            SERVER_HOST=0.0.0.0
            LOG_LEVEL=${{ secrets.LOG_LEVEL || 'WARNING' }}
            DOMAIN=${DOMAIN}
            EOF
            
            # Config dosyasƒ± olu≈ütur (PORT YOK!)
            mkdir -p configurations
            cat > configurations/prod.ini << EOF
            [app]
            name = MiniFlow
            environment = production
            debug = false
            
            [server]
            host = 0.0.0.0
            workers = 1
            
            [database]
            type = sqlite
            path = ${DATA_DIR}/miniflow.db
            
            [logging]
            level = WARNING
            file = ${LOG_DIR}/app.log
            EOF
            
            # Database setup
            echo "üóÑÔ∏è Setting up database..."
            python3.11 -m src.miniflow setup
            python3.11 -m src.miniflow migrate || echo "No migrations"
            
            # Systemd servisi olu≈ütur - PORT 80 i√ßin yetki eklendi!
            echo "‚öôÔ∏è Creating systemd service..."
            sudo tee /etc/systemd/system/${APP_NAME}.service > /dev/null << SERVICEEOF
            [Unit]
            Description=MiniFlow Application v${VERSION}
            After=network.target
            
            [Service]
            Type=simple
            User=ubuntu
            WorkingDirectory=${APP_DIR}
            Environment="PATH=/home/ubuntu/.local/bin:/usr/bin"
            Environment="PYTHONPATH=${APP_DIR}"
            EnvironmentFile=${APP_DIR}/.env
            ExecStart=/usr/bin/python3.11 -m src.miniflow run
            
            # Port 80'e eri≈üim i√ßin gerekli yetki
            AmbientCapabilities=CAP_NET_BIND_SERVICE
            CapabilityBoundingSet=CAP_NET_BIND_SERVICE
            
            Restart=always
            RestartSec=10
            StandardOutput=append:${LOG_DIR}/app.log
            StandardError=append:${LOG_DIR}/error.log
            
            [Install]
            WantedBy=multi-user.target
            SERVICEEOF
            
            # Servisi yenile ve ba≈ülat
            sudo systemctl daemon-reload
            sudo systemctl enable ${APP_NAME}
            sudo systemctl restart ${APP_NAME}
            
            # Health check (PORT YOK!)
            echo "üè• Health checking..."
            for i in {1..20}; do
              if curl -f -s http://${DOMAIN}/health > /dev/null 2>&1; then
                echo "‚úÖ Application is running on port 80!"
                break
              fi
              if [ $i -eq 20 ]; then
                echo "‚ùå Health check failed!"
                sudo journalctl -u ${APP_NAME} -n 20 --no-pager
                exit 1
              fi
              sleep 2
            done
            
            echo ""
            echo "‚úÖ Deployment completed!"
            echo "üåê http://${DOMAIN} (Port 80)"
            echo "Logs: sudo journalctl -u ${APP_NAME} -f"

      - name: Test deployment
        run: |
          sleep 5
          curl -f http://miniflow.vidinsight.com.tr/health

  rollback:
    name: üîÑ Restart Service
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.rollback
    environment:
      name: production
    
    steps:
      - name: Restart MiniFlow
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          script: |
            echo "üîÑ Restarting MiniFlow service..."
            sudo systemctl restart miniflow
            
            for i in {1..10}; do
              if curl -f -s http://miniflow.vidinsight.com.tr/health > /dev/null 2>&1; then
                echo "‚úÖ Service restarted successfully!"
                exit 0
              fi
              sleep 3
            done
            
            echo "‚ùå Service restart failed!"
            sudo journalctl -u miniflow -n 20 --no-pager
            exit 1
