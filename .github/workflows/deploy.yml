name: MiniFlow CD (Deploy & Restart)

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      rollback:
        description: 'Restart service'
        type: boolean
        default: false

env:
  PYTHON_VERSION: "3.11"

jobs:
  deploy-production:
    name: ğŸš€ Deploy to Production
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && !inputs.rollback)
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://miniflow.vidinsight.com.tr:8000
    
    steps:
      - name: Deploy and manage service
        uses: appleboy/ssh-action@v1.0.3
        env:
          VERSION: ${{ github.run_number }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          envs: VERSION,GITHUB_REPO,GITHUB_TOKEN
          command_timeout: 30m
          script: |
            set -euo pipefail
            
            APP_NAME="miniflow"
            APP_DIR="/opt/miniflow/app"
            DATA_DIR="/opt/miniflow/data"
            LOG_DIR="/opt/miniflow/logs"
            DOMAIN="miniflow.vidinsight.com.tr"
            PORT=8000
            
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # CHECK: Servis var mÄ±?
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if [ -f "/etc/systemd/system/${APP_NAME}.service" ]; then
              echo "âœ… Service EXISTS. Updating code and restarting..."
              
              # Kod dizinine git
              cd "${APP_DIR}" || { echo "âŒ App directory not found!"; exit 1; }
              
              # Son kodu Ã§ek
              echo "ğŸ“¥ Pulling latest code..."
              git pull origin main || { echo "âŒ Git pull failed!"; exit 1; }
              
              # Dependency gÃ¼ncelle
              echo "ğŸ“¦ Updating dependencies..."
              pip3 install --user --upgrade -r requirements.txt
            
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # CREATE: Servis yoksa sÄ±fÄ±rdan oluÅŸtur
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            else
              echo "ğŸ†• Service NOT FOUND. Creating from scratch..."
              
              # Dizinleri oluÅŸtur
              echo "ğŸ“ Creating directories..."
              sudo mkdir -p "${APP_DIR}" "${DATA_DIR}" "${LOG_DIR}"
              sudo chown -R ubuntu:ubuntu /opt/miniflow
              
              # Repo'yu klonla
              echo "ğŸ“¦ Cloning repository..."
              cd /opt/miniflow
              git clone --depth 1 --branch main \
                https://${GITHUB_TOKEN}@github.com/${GITHUB_REPO}.git \
                "${APP_DIR}" || { echo "âŒ Git clone failed!"; exit 1; }
              
              cd "${APP_DIR}"
              
              # BaÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼kle
              echo "ğŸ“¦ Installing dependencies..."
              pip install --user --upgrade pip setuptools wheel
              pip install --user -r requirements.txt
              
              # Environment dosyasÄ± oluÅŸtur
              echo "ğŸ“ Creating environment file..."
              echo "TEST_KEY=ThisKeyIsForConfigTest" > .env
              echo "APP_ENV=dev" >> .env
              echo "DB_TYPE=sqlite" >> .env
              echo "JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}" >> .env
              echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
              echo "MAILTRAP_API_KEY=${{ secrets.MAILTRAP_API_KEY }}" >> .env
              
              # Database setup
              echo "ğŸ—„ï¸ Setting up database..."
              python3 -m src.miniflow setup
              
              # Systemd servis dosyasÄ± oluÅŸtur
              echo "âš™ï¸ Creating systemd service..."
              echo "[Unit]" | sudo tee /etc/systemd/system/${APP_NAME}.service > /dev/null
              echo "Description=MiniFlow Application v${VERSION}" | sudo tee -a /etc/systemd/system/${APP_NAME}.service > /dev/null
              echo "After=network.target" | sudo tee -a /etc/systemd/system/${APP_NAME}.service > /dev/null
              echo "" | sudo tee -a /etc/systemd/system/${APP_NAME}.service > /dev/null
              echo "[Service]" | sudo tee -a /etc/systemd/system/${APP_NAME}.service > /dev/null
              echo "Type=simple" | sudo tee -a /etc/systemd/system/${APP_NAME}.service > /dev/null
              echo "User=ubuntu" | sudo tee -a /etc/systemd/system/${APP_NAME}.service > /dev/null
              echo "WorkingDirectory=${APP_DIR}" | sudo tee -a /etc/systemd/system/${APP_NAME}.service > /dev/null
              echo "Environment=\"PATH=/home/ubuntu/.local/bin:/usr/bin\"" | sudo tee -a /etc/systemd/system/${APP_NAME}.service > /dev/null
              echo "Environment=\"PYTHONPATH=${APP_DIR}\"" | sudo tee -a /etc/systemd/system/${APP_NAME}.service > /dev/null
              echo "EnvironmentFile=${APP_DIR}/.env" | sudo tee -a /etc/systemd/system/${APP_NAME}.service > /dev/null
              echo "ExecStart=/usr/bin/python3 -m src.miniflow run" | sudo tee -a /etc/systemd/system/${APP_NAME}.service > /dev/null
              echo "" | sudo tee -a /etc/systemd/system/${APP_NAME}.service > /dev/null
              echo "Restart=always" | sudo tee -a /etc/systemd/system/${APP_NAME}.service > /dev/null
              echo "RestartSec=10" | sudo tee -a /etc/systemd/system/${APP_NAME}.service > /dev/null
              echo "StandardOutput=append:${LOG_DIR}/app.log" | sudo tee -a /etc/systemd/system/${APP_NAME}.service > /dev/null
              echo "StandardError=append:${LOG_DIR}/error.log" | sudo tee -a /etc/systemd/system/${APP_NAME}.service > /dev/null
              echo "" | sudo tee -a /etc/systemd/system/${APP_NAME}.service > /dev/null
              echo "[Install]" | sudo tee -a /etc/systemd/system/${APP_NAME}.service > /dev/null
              echo "WantedBy=multi-user.target" | sudo tee -a /etc/systemd/system/${APP_NAME}.service > /dev/null
              
              # Systemd'yÄ± yenile ve servisi etkinleÅŸtir
              sudo systemctl daemon-reload
              sudo systemctl enable ${APP_NAME}
            fi
            
            echo "ğŸ”„ Restarting ${APP_NAME} service..."
            sudo systemctl restart ${APP_NAME}
            
            # Health check
            echo "ğŸ¥ Health checking on port ${PORT}..."
            sudo journalctl -u ${APP_NAME} -n 20 --no-pager
            

  rollback:
    name: ğŸš¨ Emergency Restart
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.rollback
    environment:
      name: production
    
    steps:
      - name: Restart MiniFlow Service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          script: |
            echo "ğŸš¨ Emergency restart requested..."
            sudo systemctl restart miniflow
            sudo journalctl -u miniflow -n 20 --no-pager
            exit 1
